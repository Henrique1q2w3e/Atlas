{% extends "base.html" %}

{% block title %}Finalizar Compra - Atlas Suplementos{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-indigo-900 py-8">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Cabeçalho melhorado -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full mb-6 shadow-2xl">
                <i class="fas fa-shopping-cart text-white text-2xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-4">
                Finalizar Compra
            </h1>
            <p class="text-lg text-gray-300 max-w-2xl mx-auto">
                Complete seu pedido de forma rápida e segura. Seus dados estão protegidos com criptografia SSL.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Formulário -->
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 border border-gray-700">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-user text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Dados Completos</h2>
                        <p class="text-gray-300">Preencha suas informações</p>
                    </div>
                </div>
                
                <form id="checkout-form">
                    <!-- Seção: Dados Pessoais -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-user-circle text-yellow-400 mr-2"></i>
                            Dados Pessoais
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-user text-gray-400 mr-2"></i>Nome Completo *
                                </label>
                                <input type="text" id="nome" name="nome" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-envelope text-gray-400 mr-2"></i>Email *
                                </label>
                                <input type="email" id="email" name="email" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-phone text-yellow-400 mr-2"></i>
                            Contato
                        </h3>
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                <i class="fas fa-phone text-gray-400 mr-2"></i>Telefone *
                            </label>
                            <input type="tel" id="telefone" name="telefone" placeholder="(11) 99999-9999" required 
                                   class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-map-marker-alt text-yellow-400 mr-2"></i>
                            Endereço
                        </h3>
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                <i class="fas fa-home text-gray-400 mr-2"></i>Endereço Completo *
                            </label>
                            <textarea id="endereco" name="endereco" rows="3" required 
                                      placeholder="Rua, número, bairro, cidade, estado, CEP"
                                      class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400 resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Seção: Documentos -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-id-card text-yellow-400 mr-2"></i>
                            Documentos
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-id-card text-gray-400 mr-2"></i>CPF *
                                </label>
                                <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-calendar text-gray-400 mr-2"></i>Data de Nascimento *
                                </label>
                                <input type="date" id="data_nascimento" name="data_nascimento" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white">
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Localização -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-map text-yellow-400 mr-2"></i>
                            Localização
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-mail-bulk text-gray-400 mr-2"></i>CEP *
                                </label>
                                <input type="text" id="cep" name="cep" placeholder="00000-000" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-city text-gray-400 mr-2"></i>Cidade *
                                </label>
                                <input type="text" id="cidade" name="cidade" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                        </div>
                    </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-flag text-gray-400 mr-2"></i>Estado *
                                </label>
                                <select id="estado" name="estado" required 
                                        class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white">
                                    <option value="">Selecione o estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                            <div class="group">
                                <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                    <i class="fas fa-building text-gray-400 mr-2"></i>Bairro *
                                </label>
                                <input type="text" id="bairro" name="bairro" required 
                                       class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Observações -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-sticky-note text-yellow-400 mr-2"></i>
                            Observações
                        </h3>
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-300 mb-3 group-focus-within:text-yellow-400 transition-colors">
                                <i class="fas fa-comment text-gray-400 mr-2"></i>Observações (opcional)
                            </label>
                            <textarea id="observacoes" name="observacoes" rows="3" 
                                      placeholder="Alguma observação especial para o pedido? Instruções de entrega, preferências, etc."
                                      class="w-full px-4 py-4 border-2 border-gray-600 rounded-xl focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400 resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Botão de Pagamento -->
                    <div class="mt-8">
                        <button type="button" onclick="irParaMercadoPago()" id="btn-pagar" 
                                class="w-full bg-gradient-to-r from-yellow-400 via-orange-500 to-yellow-500 text-white py-5 px-8 rounded-2xl font-bold text-xl hover:from-yellow-500 hover:via-orange-600 hover:to-yellow-600 transition-all duration-300 shadow-2xl hover:shadow-yellow-500/25 transform hover:scale-[1.02] active:scale-[0.98]">
                            <div class="flex items-center justify-center">
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-credit-card text-white text-lg"></i>
                                </div>
                                <span>Finalizar Pagamento</span>
                                <div class="ml-4">
                                    <i class="fas fa-arrow-right text-white"></i>
                                </div>
                            </div>
                        </button>
                        <p class="text-center text-sm text-gray-400 mt-4">
                            <i class="fas fa-shield-alt text-yellow-400 mr-2"></i>
                            Pagamento 100% seguro via Mercado Pago
                        </p>
                    </div>
                </form>
            </div>

            <!-- Resumo do Pedido -->
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 border border-gray-700">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-shopping-bag text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Resumo do Pedido</h2>
                        <p class="text-gray-300">Confira seus itens</p>
                    </div>
                </div>
                
                <div id="resumo-produtos" class="space-y-4 mb-6">
                    <!-- Produtos serão carregados aqui -->
                </div>

                <div class="border-t-2 border-gray-600 pt-6">
                    <div class="bg-gradient-to-r from-yellow-400/10 to-orange-500/10 rounded-2xl p-6 border border-yellow-400/20">
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-white">Total:</span>
                            <span id="total-pedido" class="text-3xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 space-y-6">
                    <div class="p-6 bg-gradient-to-r from-yellow-400/10 to-orange-500/10 rounded-2xl border border-yellow-400/20">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-shield-alt text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white">Pagamento Seguro</h3>
                        </div>
                        <p class="text-gray-300 leading-relaxed">
                            Você será redirecionado para o Mercado Pago, onde poderá pagar com cartão, PIX ou boleto de forma 100% segura.
                        </p>
                    </div>

                    <div class="p-6 bg-gradient-to-r from-yellow-400/10 to-orange-500/10 rounded-2xl border border-yellow-400/20">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-truck text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white">Entrega Rápida</h3>
                        </div>
                        <p class="text-gray-300 leading-relaxed">
                            Seus produtos serão enviados em até 2 dias úteis após a confirmação do pagamento.
                        </p>
                    </div>

                    <div class="p-6 bg-gradient-to-r from-yellow-400/10 to-orange-500/10 rounded-2xl border border-yellow-400/20">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-headset text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white">Suporte 24/7</h3>
                        </div>
                        <p class="text-gray-300 leading-relaxed">
                            Nossa equipe está sempre disponível para ajudar com qualquer dúvida sobre seu pedido.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Carregar carrinho ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
    carregarCarrinho();
    aplicarMascaras();
});

// Aplicar máscaras nos campos
function aplicarMascaras() {
    // Máscara para CPF
    const cpfInput = document.getElementById('cpf');
    cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
    });

    // Máscara para CEP
    const cepInput = document.getElementById('cep');
    cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{5})(\d)/, '$1-$2');
        e.target.value = value;
    });

    // Máscara para telefone
    const telefoneInput = document.getElementById('telefone');
    telefoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
        value = value.replace(/(\d{4})-(\d)(\d{4})/, '$1$2-$3');
        e.target.value = value;
    });
}

// Função para carregar carrinho
async function carregarCarrinho() {
    try {
        const response = await fetch('/api/carrinho');
        const carrinho = await response.json();
        
        const resumoProdutos = document.getElementById('resumo-produtos');
        const totalPedido = document.getElementById('total-pedido');
        
        if (!carrinho || carrinho.length === 0) {
            resumoProdutos.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shopping-cart text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-300 text-lg font-medium">Carrinho vazio</p>
                    <p class="text-gray-400 text-sm mt-2">Adicione produtos para continuar</p>
                </div>
            `;
            totalPedido.textContent = 'R$ 0,00';
            return;
        }
        
        let html = '';
        let total = 0;
        
        carrinho.forEach(item => {
            const subtotal = item.preco * item.quantidade;
            total += subtotal;
            
            html += `
                <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-700 to-gray-600 rounded-xl border border-gray-600 hover:shadow-md transition-all duration-200">
                    <div class="flex-1">
                        <div class="font-bold text-white text-lg">${item.nome}</div>
                        <div class="text-sm text-gray-300 mt-1">${item.sabor || ''} - Qtd: ${item.quantidade}</div>
                    </div>
                    <div class="text-right">
                        <span class="font-bold text-yellow-400 text-xl">R$ ${subtotal.toFixed(2).replace('.', ',')}</span>
                    </div>
                </div>
            `;
        });
        
        resumoProdutos.innerHTML = html;
        totalPedido.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        
    } catch (error) {
        console.error('Erro ao carregar carrinho:', error);
        document.getElementById('resumo-produtos').innerHTML = `
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-red-900/50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                </div>
                <p class="text-red-400 text-lg font-medium">Erro ao carregar carrinho</p>
                <p class="text-gray-400 text-sm mt-2">Tente recarregar a página</p>
            </div>
        `;
    }
}

// Função para ir direto para o Mercado Pago
function irParaMercadoPago() {
    console.log('🚀 Redirecionando para Mercado Pago...');
    
    // Coletar dados do formulário
    const nome = document.getElementById('nome').value;
    const email = document.getElementById('email').value;
    const telefone = document.getElementById('telefone').value;
    const endereco = document.getElementById('endereco').value;
    const cpf = document.getElementById('cpf').value;
    const dataNascimento = document.getElementById('data_nascimento').value;
    const cep = document.getElementById('cep').value;
    const cidade = document.getElementById('cidade').value;
    const estado = document.getElementById('estado').value;
    const bairro = document.getElementById('bairro').value;
    const observacoes = document.getElementById('observacoes').value;
    
    // Validar dados obrigatórios
    if (!nome || !email || !telefone || !endereco || !cpf || !dataNascimento || !cep || !cidade || !estado || !bairro) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    // Mostrar loading
    const btn = document.getElementById('btn-pagar');
    btn.disabled = true;
    btn.innerHTML = `
        <div class="flex items-center justify-center">
            <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-spinner fa-spin text-white text-lg"></i>
            </div>
            <span>Redirecionando...</span>
        </div>
    `;
    
    // Criar pagamento usando API
    const dadosCliente = {
        nome: nome,
        email: email,
        telefone: telefone,
        endereco: endereco,
        cpf: cpf,
        data_nascimento: dataNascimento,
        cep: cep,
        cidade: cidade,
        estado: estado,
        bairro: bairro,
        observacoes: observacoes
    };
    
    fetch('/api/criar-pagamento-simples', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dados_cliente: dadosCliente
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.init_point) {
            // Redirecionar para o Mercado Pago com os produtos corretos
            window.location.href = data.init_point;
        } else {
            alert('Erro ao criar pagamento: ' + (data.error || 'Erro desconhecido'));
            // Restaurar botão
            btn.disabled = false;
            btn.innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-credit-card text-white text-lg"></i>
                    </div>
                    <span>Finalizar Pagamento</span>
                    <div class="ml-4">
                        <i class="fas fa-arrow-right text-white"></i>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar pagamento. Tente novamente.');
        // Restaurar botão
        btn.disabled = false;
        btn.innerHTML = `
            <div class="flex items-center justify-center">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-credit-card text-white text-lg"></i>
                </div>
                <span>Finalizar Pagamento</span>
                <div class="ml-4">
                    <i class="fas fa-arrow-right text-white"></i>
                </div>
            </div>
        `;
    });
}
</script>

<!-- Validação de formulário -->
<script src="/static/js/validacao.js"></script>
<script>
// Validação antes de enviar o formulário
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    if (!validarFormulario()) {
        e.preventDefault();
        alert('Por favor, corrija os erros no formulário antes de continuar.');
        return false;
    }
});
</script>
{% endblock %}